FROM node:22-bookworm-slim AS builder

WORKDIR /app
COPY idealistaPropertyScraper/package*.json ./
COPY modules/captchaSolvers /modules/captchaSolvers
COPY modules/proxy /modules/proxy
RUN npm --prefix /modules/captchaSolvers ci \
    && npm --prefix /modules/captchaSolvers run build \
    && npm --prefix /modules/proxy ci \
    && npm --prefix /modules/proxy run build
RUN npm ci
COPY idealistaPropertyScraper/ ./
RUN npm run build

FROM node:22-bookworm-slim AS runtime

ENV DEBIAN_FRONTEND=noninteractive

RUN apt-get update && apt-get install -y --no-install-recommends \
    ca-certificates \
    curl \
    gnupg \
    && rm -rf /var/lib/apt/lists/*

RUN apt-get update && apt-get install -y --no-install-recommends \
    chromium \
    chromium-sandbox \
    dbus-x11 \
    dnsutils \
    dumb-init \
    emacs-nox \
    g++ \
    gcc \
    htop \
    iputils-ping \
    libdbus-1-3 \
    libsixel-bin \
    make \
    nfs-common \
    net-tools \
    python3 \
    telnet \
    wget \
    x11-utils \
    x11vnc \
    xauth \
    xdotool \
    xosview \
    xterm \
    xvfb \
    && (apt-get install -y --no-install-recommends mwm || true) \
    && rm -rf /var/lib/apt/lists/* \
    && npm install -g mongosh

RUN set -eux; \
    arch="$(dpkg --print-architecture)"; \
    if [ "$arch" = "amd64" ]; then \
      install -m 0755 -d /etc/apt/keyrings; \
      curl -fsSL https://dl.google.com/linux/linux_signing_key.pub | gpg --dearmor -o /etc/apt/keyrings/google-chrome.gpg; \
      chmod a+r /etc/apt/keyrings/google-chrome.gpg; \
      echo "deb [arch=amd64 signed-by=/etc/apt/keyrings/google-chrome.gpg] http://dl.google.com/linux/chrome/deb/ stable main" > /etc/apt/sources.list.d/google-chrome.list; \
      apt-get update; \
      apt-get install -y --no-install-recommends google-chrome-stable; \
      ln -sf /usr/bin/google-chrome-stable /usr/local/bin/browser-cdp; \
    else \
      apt-get update; \
      apt-get install -y --no-install-recommends chromium; \
      ln -sf /usr/bin/chromium /usr/local/bin/browser-cdp; \
    fi; \
    rm -rf /var/lib/apt/lists/*

WORKDIR /app
COPY idealistaPropertyScraper/package*.json ./
COPY --from=builder /modules/captchaSolvers/package.json /modules/captchaSolvers/package.json
COPY --from=builder /modules/captchaSolvers/dist /modules/captchaSolvers/dist
COPY --from=builder /modules/proxy/package.json /modules/proxy/package.json
COPY --from=builder /modules/proxy/dist /modules/proxy/dist
RUN npm ci --omit=dev
COPY --from=builder /app/dist ./dist
COPY idealistaPropertyScraper/environment.json ./environment.json
COPY idealistaPropertyScraper/secrets-example.json ./secrets-example.json
COPY idealistaPropertyScraper/k8s/x11vnc-launcher.sh /usr/local/bin/x
COPY idealistaPropertyScraper/start-with-xvfb.sh /usr/local/bin/start-with-xvfb.sh
RUN sed -i 's#/Applications/Google Chrome.app/Contents/MacOS/Google Chrome#/usr/local/bin/browser-cdp#g' environment.json
RUN chmod +x /usr/local/bin/start-with-xvfb.sh /usr/local/bin/x \
    && groupadd -g 1001 scraper \
    && useradd -u 1001 -g 1001 -m -s /bin/bash scraper \
    && echo 'scraper:password' | chpasswd \
    && mkdir -p /app/output/logs /app/output/.vnc /app/output/images \
    && chown -R scraper:scraper /app /home/scraper

USER scraper

CMD ["dumb-init", "/usr/local/bin/start-with-xvfb.sh"]
